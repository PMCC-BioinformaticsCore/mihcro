---
title: "QC report: `r params$samplename`"
params:
  samplename:
  cellbyfeature:
  markerfile:
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    code_folding: hide
---

# setup

```{r, warning=FALSE, include=FALSE, echo=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(ggcorrplot)
library(Seurat)
library(tibble)
library(pheatmap)
library(kableExtra)


samplename <- params$samplename
message("Running QC Report for:", samplename)

cbf_path <- params$cellbyfeature
message("Cell by feature csv at:", cbf_path)
mesmer_data <- read.csv(cbf_path, na.strings=c("", "inf"))
colnames(mesmer_data) <- colnames(mesmer_data) %>% make.names() %>% trimws()
mesmer_data <- mesmer_data %>% drop_na()

mark_path <- params$markerfile
message("Markerfile at:", mark_path)
markerfile <- read.csv(mark_path, header=TRUE)
marker_number <- nrow(markerfile)
markerfile$marker_name <- markerfile$marker_name %>% make.names() %>% trimws()

```

```{r, echo=FALSE}
if (any(!markerfile$marker_name %in% colnames(mesmer_data))) {

    warning("Some of the markers listed in the markerfile are not present in the data:",
            paste(markerfile$marker_name[!markerfile$marker_name %in% colnames(mesmer_data)])
            )

}

eff_markers <- intersect(markerfile$marker_name, colnames(mesmer_data))

mesmer_marker <- mesmer_data %>% select(CellID, all_of(eff_markers)) %>%
  pivot_longer(cols = -CellID,
               names_to = "Marker",
               values_to = "Value")

```

```{r, echo=FALSE}
flag <- mesmer_marker %>% group_by(CellID) %>% filter(sum(Value)>1e+30) %>% pull(CellID) %>% unique()

if (length(flag)>0) {
  warning("Certain 'cells' appear to have unrealistically high intensities and will be removed.\nProblematic rows:")
  print(mesmer_data %>% filter(CellID %in% flag))
  mesmer_data <- mesmer_data %>% filter(!CellID %in% flag)
  mesmer_marker <- mesmer_marker %>% filter(!CellID %in% flag)
}
```

# morphology {.tabset}
## statistic table
```{r}
Morphology_mesmer <- mesmer_data[, c("Area", "MajorAxisLength", "MinorAxisLength", "Eccentricity", "Solidity", "Extent", "Orientation")]

area_summary <- Morphology_mesmer %>%
  summarise(
    Detecter = "Mesmer",
    Mean = round(mean(Area),2),
    Median = median(Area),
    SD = round(sd(Area),2),
    Min = min(Area),
    Max = max(Area)
  )

area_summary %>%
  kbl(caption = "Area Statistical Table") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

## Cell area distribution
```{r}
Morphology_mesmer$Detecter   <- "Mesmer"

ggplot(Morphology_mesmer, aes(x = Area, fill = Detecter)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  facet_wrap(~Detecter, scales = "free", ncol = 2) +
  labs(
    title = "Area Distribution",
    x = "Area (µm²)",
    y = "Density"
  )


```

## Eccentricity distribution
```{r}
ggplot(Morphology_mesmer, aes(x = Eccentricity, fill = Detecter)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  facet_wrap(~Detecter, scales = "free", ncol = 2) +
  labs(
    title = "Eccentricity Distribution",
    x = "Eccentricity (µm²)",
    y = "Density"
  )
```

## Solidity distribution
```{r}
ggplot(Morphology_mesmer, aes(x = Solidity, fill = Detecter)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  facet_wrap(~Detecter, scales = "free", ncol = 2) +
  labs(
    title = "Solidity Distribution",
    x = "Solidity (µm²)",
    y = "Density"
  )
```

## Extent distribution
```{r}
ggplot(Morphology_mesmer, aes(x = Extent, fill = Detecter)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  facet_wrap(~Detecter, scales = "free", ncol = 2) +
  labs(
    title = "Extent Distribution",
    x = "Extent (µm²)",
    y = "Density"
  )
```

# descriptive statistics {.tabset}
## raw
```{r, echo=FALSE}
mesmer_summary <- mesmer_marker %>%
  group_by(Marker) %>%
  summarise(
    Mean = mean(Value),
    Median = median(Value),
    SD = sd(Value),
    Min = min(Value),
    Max = max(Value)
  )
mesmer_summary %>%
  kbl(caption = "Statistical Table") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

## CLR transformation
```{r, echo=FALSE}
df_clr_mesmer <- mesmer_marker %>%
  group_by(CellID) %>%
  mutate(Value_CLR = log(Value + 1) - mean(log(Value + 1), na.rm = TRUE)) %>%
  ungroup()

mesmer_log_summary <- df_clr_mesmer %>%
  group_by(Marker) %>%
  summarise(
    Mean = mean(Value_CLR),
    Median = median(Value_CLR),
    SD = sd(Value_CLR),
    Min = min(Value_CLR),
    Max = max(Value_CLR)
  )
mesmer_log_summary %>%
  kbl(caption = "Statistical Table") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

# Histogram of marker intensity {.tabset}
## raw
```{r, echo=FALSE}
ggplot(mesmer_marker, aes(x = Value, fill = Marker)) +
  geom_density() +
  theme_minimal() +
  facet_wrap(~Marker, scales = "free", ncol = 4) +
  labs(title = "Marker intensity",
       x = "intensity", y = "density")
```

## CLR transformation
```{r, echo=FALSE}

ggplot(df_clr_mesmer, aes(x = Value_CLR, fill = Marker)) +
  geom_density() +
  theme_minimal() +
  facet_wrap(~Marker, scales = "free", ncol = 4) +
  labs(title = "Marker intensity",
       x = "intensity", y = "density")
```

# Boxplot {.tabset}
## raw
```{r, echo=FALSE}
ggplot(mesmer_marker, aes(x = Marker, y = Value, fill = Marker)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Boxplot of intensity distribution",
       x = "markers", y = "intensity")
```

## CLR transformation
```{r, echo=FALSE}

ggplot(df_clr_mesmer, aes(x = Marker, y = Value_CLR, fill = Marker)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Boxplot of intensity distribution",
       x = "markers", y = "intensity")
```

# correlation between markers {.tabset}

```{r, echo=FALSE}

mesmer_corr_matrix <- mesmer_data %>% select(all_of(eff_markers)) %>%
  cor() %>%
  round(digits=2)

ggcorrplot(mesmer_corr_matrix, hc.order =FALSE,
           type ="lower", lab =TRUE)+
  ggtitle("Pearson Correlation Heatmap of Marker Intensities")
```

# QQ plot {.tabset}
## raw
```{r, echo=FALSE}
n_cells <- n_distinct(mesmer_marker$CellID)
if (n_cells > 100000) {
  print("downsampling large dataset...")
  sampled_cells <- sample(unique(mesmer_marker$CellID), size = 100000, replace = FALSE)
  mesmer_marker <- mesmer_marker[mesmer_marker$CellID %in% sampled_cells, ]
  df_clr_mesmer <- df_clr_mesmer[df_clr_mesmer$CellID %in% sampled_cells, ]
}

ggplot(mesmer_marker, aes(sample = Value, fill = Marker, color = Marker)) +
  stat_qq() +
  stat_qq_line() +
  theme_minimal() +
  facet_wrap(~Marker, scales = "free", ncol = 4) +
  labs(title = "QQ plot",
       x = "Theoretical Quantiles", y = "Sample Quantiles")
```

## CLR transformation
```{r, echo=FALSE}

ggplot(df_clr_mesmer, aes(sample = Value_CLR, color = Marker)) +
  stat_qq() +
  stat_qq_line() +
  theme_minimal() +
  facet_wrap(~Marker, scales = "free", ncol = 4) +
  labs(title = "QQ plot",
       x = "Theoretical Quantiles", y = "Sample Quantiles")
```


# Clustering analysis (CLR-transformed data) {.tabset .tabset-pills}

```{r, echo=FALSE, warning=FALSE, include=F}
mesmer_data$CellID <- make.unique(as.character(mesmer_data$CellID))
marker_cols <- setdiff(eff_markers, "DAPI")
meta_cols <- setdiff(colnames(mesmer_data), marker_cols)

expr_mesmer <- t(as.matrix(mesmer_data[, marker_cols, drop = FALSE]))
colnames(expr_mesmer) <- mesmer_data$CellID
expr_mesmer[is.na(expr_mesmer)] <- 0

meta_df_mesmer <- mesmer_data[, meta_cols, drop = FALSE] %>% column_to_rownames("CellID")

seu_mesmer <- CreateSeuratObject(
  counts    = expr_mesmer,
  assay     = "PROT",
  meta.data = meta_df_mesmer
)

DefaultAssay(seu_mesmer) <- "PROT"
seu_mesmer <- NormalizeData(seu_mesmer, normalization.method = "CLR", margin = 2, verbose = FALSE)
VariableFeatures(seu_mesmer) <- rownames(seu_mesmer)
seu_mesmer <- ScaleData(seu_mesmer, verbose = FALSE)

n_cells <- ncol(seu_mesmer)
use_sketch <- n_cells > 100000

if (use_sketch) {
  message(sprintf("Using sketch approach for %d cells", n_cells))

  # Sketch for clustering
  seu_mesmer <- SketchData(
    seu_mesmer,
    ncells = 50000,
    method = "LeverageScore",
    sketched.assay = "sketch"
  )

  # Run dimensionality reduction on sketch
  DefaultAssay(seu_mesmer) <- "sketch"
  seu_mesmer <- ScaleData(seu_mesmer, verbose = T)
  seu_mesmer <- RunPCA(seu_mesmer, npcs = 6, verbose = T)
  pcs_use <- 1:min(6, ncol(Embeddings(seu_mesmer, "pca")))
  seu_mesmer <- RunUMAP(seu_mesmer, dims = pcs_use, verbose = T,
                        reduction.name = "umap.sketch", reduction.key = "UMAP_sketch_")
  seu_mesmer <- FindNeighbors(seu_mesmer, dims = pcs_use, verbose = T)
  seu_mesmer <- FindClusters(seu_mesmer, resolution = c(0.25, 0.5, 0.75, 1), verbose = T)

  seu_mesmer <- ProjectData(
    object = seu_mesmer,
    assay = "PROT",
    full.reduction = "pca.full",
    sketched.assay = "sketch",
    sketched.reduction = "pca",
    umap.model = "umap.sketch",
    dims = pcs_use,
    refdata = list(
      PROT_snn_res.0.25 = "sketch_snn_res.0.25",
      PROT_snn_res.0.5 = "sketch_snn_res.0.5",
      PROT_snn_res.0.75 = "sketch_snn_res.0.75",
      PROT_snn_res.1 = "sketch_snn_res.1"
    )
  )

  DefaultAssay(seu_mesmer) <- "PROT"

} else {
  # Original approach for smaller datasets
  seu_mesmer <- RunPCA(seu_mesmer, npcs = 6, features = VariableFeatures(seu_mesmer), verbose = T)
  pcs_use <- 1:min(6, ncol(Embeddings(seu_mesmer, "pca")))
  seu_mesmer <- FindNeighbors(seu_mesmer, reduction = "pca", dims = pcs_use, verbose = T)
  seu_mesmer <- RunUMAP(seu_mesmer, dims = pcs_use, verbose = T)
  seu_mesmer <- FindClusters(seu_mesmer, resolution = c(0.25, 0.5, 0.75, 1), verbose = T)
}
```

```{r}
discrete.pal <- c("#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#42d4f4", "#f032e6", "#bfef45", "#fabed4", "#469990", "#dcbeff", "#9a6324", "#fffac8", "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#a9a9a9",
                  "#993F00", "#4C005C", "#005C31", "#2BCE48", "#94FFB5", "#C20088", "#FFA405", "#5EF1F2", "#00998F", "lightgrey")

```


## resolution = 0.25

```{r, echo = FALSE, warning=FALSE, fig.dim=c(10,10)}
resolution=0.25
seu_mesmer$seurat_clusters <- seu_mesmer[[paste0("PROT_snn_res.", resolution)]]
Idents(seu_mesmer) <- "seurat_clusters"
# visualization
## umap
umap_red <- if(use_sketch) "umap.sketch" else "umap"
if (use_sketch) {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
} else {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
}
## tissue image
centroids = seu_mesmer[[]] %>% rownames_to_column("bc") %>% mutate(y=X_centroid, x=Y_centroid, cell=bc) %>% dplyr::select(x,y,cell)
ff=CreateFOV(coords = centroids, type = "centroids", key = "fov", assay = "PROT")
seu_mesmer[["myfov"]]=ff
ImageDimPlot(seu_mesmer, size=1, , cols=discrete.pal) + scale_y_reverse()
ImageFeaturePlot(seu_mesmer, features = marker_cols, combine = TRUE) & scale_y_reverse() & theme(plot.background = element_rect(fill="black"))

#df_plot <- FetchData(seu_mesmer, vars = c("X_centroid","Y_centroid","seurat_clusters")) # extract variables
#df_plot=seu_mesmer[[]]
#ggplot(df_plot, aes(x = X_centroid, y = Y_centroid, color = res_0.2)) +
#  geom_point(size = 0.6) +
#  coord_fixed() + # coordinate ratio: 1:1
#  scale_y_reverse() +
#  theme_minimal()

## heatmap
avg <- AverageExpression(
  seu_mesmer,
  assays = "PROT",
  group.by = "seurat_clusters",
  slot = "scale.data"
)$PROT
pheatmap(avg, cluster_rows = FALSE, cluster_cols = FALSE, labels_col = levels(Idents(seu_mesmer)), scale = "column")

## violet plot

VlnPlot(
  seu_mesmer,
  features = marker_cols,
  group.by = "seurat_clusters",
  pt.size = 0,
  ncol = 3,
  same.y.lims = TRUE,
  cols=discrete.pal
)
```


## resolution = 0.5

```{r, echo = FALSE, warning=FALSE, fig.dim=c(10,10)}
resolution=0.5
seu_mesmer$seurat_clusters <- seu_mesmer[[paste0("PROT_snn_res.", resolution)]]
Idents(seu_mesmer) <- "seurat_clusters"
# visualization
## umap
umap_red <- if(use_sketch) "umap.sketch" else "umap"
if (use_sketch) {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
} else {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
}
## tissue image
centroids = seu_mesmer[[]] %>% rownames_to_column("bc") %>% mutate(y=X_centroid, x=Y_centroid, cell=bc) %>% dplyr::select(x,y,cell)
ff=CreateFOV(coords = centroids, type = "centroids", key = "fov", assay = "PROT")
seu_mesmer[["myfov"]]=ff
ImageDimPlot(seu_mesmer, size=1, , cols=discrete.pal) + scale_y_reverse()
ImageFeaturePlot(seu_mesmer, features = marker_cols, combine = TRUE) & scale_y_reverse() & theme(plot.background = element_rect(fill="black"))

#df_plot <- FetchData(seu_mesmer, vars = c("X_centroid","Y_centroid","seurat_clusters")) # extract variables
#df_plot=seu_mesmer[[]]
#ggplot(df_plot, aes(x = X_centroid, y = Y_centroid, color = res_0.2)) +
#  geom_point(size = 0.6) +
#  coord_fixed() + # coordinate ratio: 1:1
#  scale_y_reverse() +
#  theme_minimal()

## heatmap
avg <- AverageExpression(
  seu_mesmer,
  assays = "PROT",
  group.by = "seurat_clusters",
  slot = "scale.data"
)$PROT
pheatmap(avg, cluster_rows = FALSE, cluster_cols = FALSE, labels_col = levels(Idents(seu_mesmer)), scale = "column")

## violet plot

VlnPlot(
  seu_mesmer,
  features = marker_cols,
  group.by = "seurat_clusters",
  pt.size = 0,
  ncol = 3,
  same.y.lims = TRUE,
  cols=discrete.pal
)
```


## resolution = 0.75

```{r, echo = FALSE, warning=FALSE, fig.dim=c(10,10)}
resolution=0.75
seu_mesmer$seurat_clusters <- seu_mesmer[[paste0("PROT_snn_res.", resolution)]]
Idents(seu_mesmer) <- "seurat_clusters"
# visualization
## umap
umap_red <- if(use_sketch) "umap.sketch" else "umap"
if (use_sketch) {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
} else {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
}
## tissue image
centroids = seu_mesmer[[]] %>% rownames_to_column("bc") %>% mutate(y=X_centroid, x=Y_centroid, cell=bc) %>% dplyr::select(x,y,cell)
ff=CreateFOV(coords = centroids, type = "centroids", key = "fov", assay = "PROT")
seu_mesmer[["myfov"]]=ff
ImageDimPlot(seu_mesmer, size=1, , cols=discrete.pal) + scale_y_reverse()
ImageFeaturePlot(seu_mesmer, features = marker_cols, combine = TRUE) & scale_y_reverse() & theme(plot.background = element_rect(fill="black"))

#df_plot <- FetchData(seu_mesmer, vars = c("X_centroid","Y_centroid","seurat_clusters")) # extract variables
#df_plot=seu_mesmer[[]]
#ggplot(df_plot, aes(x = X_centroid, y = Y_centroid, color = res_0.2)) +
#  geom_point(size = 0.6) +
#  coord_fixed() + # coordinate ratio: 1:1
#  scale_y_reverse() +
#  theme_minimal()

## heatmap
avg <- AverageExpression(
  seu_mesmer,
  assays = "PROT",
  group.by = "seurat_clusters",
  slot = "scale.data"
)$PROT
pheatmap(avg, cluster_rows = FALSE, cluster_cols = FALSE, labels_col = levels(Idents(seu_mesmer)), scale = "column")

## violet plot

VlnPlot(
  seu_mesmer,
  features = marker_cols,
  group.by = "seurat_clusters",
  pt.size = 0,
  ncol = 3,
  same.y.lims = TRUE,
  cols=discrete.pal
)
```


## resolution = 1


```{r, echo = FALSE, warning=FALSE, fig.dim=c(10,10)}
resolution=1
seu_mesmer$seurat_clusters <- seu_mesmer[[paste0("PROT_snn_res.", resolution)]]
Idents(seu_mesmer) <- "seurat_clusters"
# visualization
## umap
umap_red <- if(use_sketch) "umap.sketch" else "umap"
if (use_sketch) {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
} else {
  DimPlot(seu_mesmer, reduction = umap_red, label = TRUE, cols=discrete.pal)
}
## tissue image
centroids = seu_mesmer[[]] %>% rownames_to_column("bc") %>% mutate(y=X_centroid, x=Y_centroid, cell=bc) %>% dplyr::select(x,y,cell)
ff=CreateFOV(coords = centroids, type = "centroids", key = "fov", assay = "PROT")
seu_mesmer[["myfov"]]=ff
ImageDimPlot(seu_mesmer, size=1, , cols=discrete.pal) + scale_y_reverse()
ImageFeaturePlot(seu_mesmer, features = marker_cols, combine = TRUE) & scale_y_reverse() & theme(plot.background = element_rect(fill="black"))

#df_plot <- FetchData(seu_mesmer, vars = c("X_centroid","Y_centroid","seurat_clusters")) # extract variables
#df_plot=seu_mesmer[[]]
#ggplot(df_plot, aes(x = X_centroid, y = Y_centroid, color = res_0.2)) +
#  geom_point(size = 0.6) +
#  coord_fixed() + # coordinate ratio: 1:1
#  scale_y_reverse() +
#  theme_minimal()

## heatmap
avg <- AverageExpression(
  seu_mesmer,
  assays = "PROT",
  group.by = "seurat_clusters",
  slot = "scale.data"
)$PROT
pheatmap(avg, cluster_rows = FALSE, cluster_cols = FALSE, labels_col = levels(Idents(seu_mesmer)), scale = "column")

## violet plot

VlnPlot(
  seu_mesmer,
  features = marker_cols,
  group.by = "seurat_clusters",
  pt.size = 0,
  ncol = 3,
  same.y.lims = TRUE,
  cols=discrete.pal
)
```


